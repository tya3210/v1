<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>防災情報マップ - 完成版</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        html, body, #map {
            height: 100%;
            margin: 0;
            padding: 0;
        }
        body {
            font-family: Arial, sans-serif;
        }
        .leaflet-popup-content {
            font-size: 14px;
        }
        .message-form {
            margin: 0;
        }
        .message-form textarea {
            width: 100%;
            height: 60px;
            resize: none;
        }
        .message-list {
            max-height: 100px;
            overflow-y: auto;
            margin-top: 10px;
        }
        .message-item {
            border-bottom: 1px solid #ccc;
            padding: 5px 0;
        }
        .message-author {
            font-weight: bold;
            margin-right: 5px;
        }
        .delete-pin {
            color: red;
            cursor: pointer;
            font-size: 12px;
            display: block;
            margin-top: 10px;
        }
        .username-container, .medical-info-button, .language-selector {
            position: absolute;
            top: 10px;
            z-index: 1000;
            background: rgba(255,255,255,0.9);
            padding: 10px;
            border-radius: 5px;
        }
        .username-container {
            right: 10px;
        }
        .medical-info-button {
            left: 50%;
            transform: translateX(-50%);
        }
        .language-selector {
            left: 10px;
        }
        .username-container input {
            width: 150px;
        }
        /* 医療情報モーダルのスタイル */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
        }
        .modal-content {
            background-color: #fff;
            margin: 10% auto;
            padding: 20px;
            width: 90%;
            max-width: 500px;
            border-radius: 5px;
        }
        .modal-content h3 {
            margin-top: 0;
        }
        .modal-content label {
            display: block;
            margin-top: 10px;
        }
        .modal-content input, .modal-content textarea {
            width: 100%;
            box-sizing: border-box;
            padding: 8px;
            margin-top: 5px;
        }
        .modal-close {
            color: #aaa;
            float: right;
            font-size: 28px;
            cursor: pointer;
        }
        /* フローティングウィンドウのスタイル */
        .info-window {
            position: absolute;
            bottom: 10px;
            left: 10px;
            z-index: 1000;
            background: rgba(255,255,255,0.9);
            padding: 10px;
            border-radius: 5px;
            max-width: 300px;
            max-height: 200px;
            overflow-y: auto;
            font-size: 14px;
        }
        .info-window h3 {
            margin-top: 0;
            font-size: 16px;
        }
        /* レスポンシブ対応 */
        @media only screen and (max-width: 600px) {
            .username-container, .medical-info-button, .language-selector {
                width: calc(100% - 20px);
                box-sizing: border-box;
                left: 10px;
                right: 10px;
                top: 10px;
                transform: none;
            }
            .username-container {
                top: 110px;
            }
            .medical-info-button {
                top: 60px;
            }
            .username-container input {
                width: calc(100% - 20px);
            }
            .language-selector {
                top: 10px;
            }
            .info-window {
                width: calc(100% - 20px);
                left: 10px;
                bottom: 70px;
            }
        }
    </style>
    <!-- LeafletのCSSを読み込み -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
</head>
<body>
    <!-- 言語選択メニュー -->
    <div class="language-selector">
        <label for="languageSelect">Language:</label>
        <select id="languageSelect">
            <option value="ja">日本語</option>
            <option value="en">English</option>
        </select>
    </div>
    <!-- ユーザー名の設定 -->
    <div class="username-container">
        <label for="usernameInput" id="nameLabel">お名前:</label><br>
        <input type="text" id="usernameInput" placeholder="ユーザー名を入力" />
    </div>
    <!-- 医療情報ボタン -->
    <div class="medical-info-button">
        <button id="openMedicalInfo">医療情報の入力・確認</button>
    </div>
    <!-- 医療情報モーダル -->
    <div id="medicalModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" id="closeMedicalModal">&times;</span>
            <h3 id="medicalInfoTitle">パーソナル医療情報</h3>
            <form id="medicalForm">
                <label for="healthStatus">健康状態・持病</label>
                <textarea id="healthStatus" rows="3" placeholder="例：高血圧、糖尿病など"></textarea>

                <label for="allergies">アレルギー情報</label>
                <textarea id="allergies" rows="2" placeholder="例：ピーナッツアレルギー、ハチ刺されアレルギー"></textarea>

                <label for="medications">常用薬</label>
                <textarea id="medications" rows="2" placeholder="例：降圧薬、インスリン注射"></textarea>

                <label for="emergencyContact">緊急連絡先</label>
                <input type="text" id="emergencyContact" placeholder="例：090-1234-5678">

                <!-- エクスポート・インポートボタン -->
                <div style="margin-top: 10px;">
                    <button type="button" id="exportData">データをエクスポート</button>
                    <button type="button" id="importData">データをインポート</button>
                </div>

                <div style="margin-top: 10px;">
                    <button type="submit" id="saveButton">保存</button>
                    <button type="button" id="logoutButton">ログアウト</button>
                </div>
            </form>
        </div>
    </div>
    <div id="map"></div>
    <!-- フローティングウィンドウ -->
    <div class="info-window" id="infoWindow">
        <h3 id="disasterInfoTitle">防災情報</h3>
        <div id="disasterInfo">最新の防災情報を取得中です...</div>
    </div>

    <!-- 必要なスクリプトの読み込み -->
    <!-- LeafletのJSを読み込み -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <!-- CryptoJSの読み込み -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <!-- DOMPurifyの読み込み -->
    <script src="https://cdn.jsdelivr.net/npm/dompurify@2.4.0/dist/purify.min.js"></script>
    <!-- Leaflet.LocateのJSを読み込み -->
    <script src="https://unpkg.com/leaflet.locatecontrol/dist/L.Control.Locate.min.js"></script>
    <script>
        // 言語設定
        const texts = {
            'ja': {
                mapTitle: "防災情報マップ",
                placeholderMessage: "伝言を入力してください",
                placeholderUsername: "ユーザー名を入力",
                postButton: "投稿",
                deletePin: "このピンを削除",
                currentLocation: "現在地",
                displayCurrentLocation: "現在地を表示",
                alertLocationError: "位置情報を取得できませんでした。",
                alertNoUsername: "ユーザー名を入力してください。",
                nameLabel: "お名前:",
                disasterInfoTitle: "防災情報",
                disasterInfoLoading: "最新の防災情報を取得中です...",
                disasterInfoError: "防災情報を取得できませんでした。",
                noDisasterInfo: "現在、特別な防災情報はありません。",
                medicalInfoTitle: "パーソナル医療情報",
                saveButton: "保存",
                closeButton: "閉じる",
                openMedicalInfo: "医療情報の入力・確認",
                exportData: "データをエクスポート",
                importData: "データをインポート",
                enterPassword: "パスワードを入力してください",
                confirmPassword: "パスワードを確認してください",
                login: "ログイン",
                logout: "ログアウト",
                passwordMismatch: "パスワードが一致しません。",
                incorrectPassword: "パスワードが間違っています。",
                medicalInfoSaved: "医療情報を保存しました。",
                medicalInfoLoadFailed: "医療情報を読み込めませんでした。"
            },
            'en': {
                mapTitle: "Disaster Information Map",
                placeholderMessage: "Enter your message",
                placeholderUsername: "Enter your username",
                postButton: "Post",
                deletePin: "Delete this pin",
                currentLocation: "Current Location",
                displayCurrentLocation: "Show current location",
                alertLocationError: "Failed to get location.",
                alertNoUsername: "Please enter your username.",
                nameLabel: "Name:",
                disasterInfoTitle: "Disaster Information",
                disasterInfoLoading: "Loading latest disaster information...",
                disasterInfoError: "Failed to load disaster information.",
                noDisasterInfo: "No special disaster information at this time.",
                medicalInfoTitle: "Personal Medical Information",
                saveButton: "Save",
                closeButton: "Close",
                openMedicalInfo: "Medical Info Input/View",
                exportData: "Export Data",
                importData: "Import Data",
                enterPassword: "Enter Password",
                confirmPassword: "Confirm Password",
                login: "Login",
                logout: "Logout",
                passwordMismatch: "Passwords do not match.",
                incorrectPassword: "Incorrect password.",
                medicalInfoSaved: "Medical information has been saved.",
                medicalInfoLoadFailed: "Failed to load medical information."
            }
        };

        // 現在の言語を保持
        var currentLang = 'ja';

        // テキストを設定する関数
        function setTexts() {
            var t = texts[currentLang];
            document.title = t.mapTitle;
            document.getElementById('nameLabel').textContent = t.nameLabel;
            usernameInput.placeholder = t.placeholderUsername;
            document.getElementById('openMedicalInfo').textContent = t.openMedicalInfo;
            document.getElementById('disasterInfoTitle').textContent = t.disasterInfoTitle;
            document.getElementById('medicalInfoTitle').textContent = t.medicalInfoTitle;
            document.getElementById('healthStatus').placeholder = t.healthStatusPlaceholder || '';
            document.getElementById('allergies').placeholder = t.allergiesPlaceholder || '';
            document.getElementById('medications').placeholder = t.medicationsPlaceholder || '';
            document.getElementById('emergencyContact').placeholder = t.emergencyContactPlaceholder || '';
            document.getElementById('saveButton').textContent = t.saveButton;
            document.getElementById('exportData').textContent = t.exportData;
            document.getElementById('importData').textContent = t.importData;
            document.getElementById('logoutButton').textContent = t.logout;
            // 他のテキストも同様に設定
        }

        // 言語選択のイベント
        document.getElementById('languageSelect').addEventListener('change', function() {
            currentLang = this.value;
            setTexts();
            // 必要に応じて再描画や再設定
        });

        // 最初のテキスト設定
        setTexts();

        // ユーザー名の管理
        var username = localStorage.getItem('username') || '';
        var usernameInput = document.getElementById('usernameInput');
        usernameInput.value = username;

        usernameInput.addEventListener('change', function() {
            username = usernameInput.value.trim();
            localStorage.setItem('username', username);
        });

        // 地図の初期化
        var map = L.map('map', {
            center: [35.681236, 139.767125],
            zoom: 13
        });

        // 地理院地図の標準タイルを追加
        var stdMap = L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png', {
            attribution:
                "<a href='https://maps.gsi.go.jp/development/ichiran.html'>地理院タイル</a>"
        }).addTo(map);

        // ハザードマップのレイヤー追加
        var floodLayer = L.tileLayer('https://disaportaldata.gsi.go.jp/raster/01_flood_l2_shinsuishin/{z}/{x}/{y}.png', {
            opacity: 0.5,
            attribution: "<a href='https://disaportal.gsi.go.jp/'>ハザードマップポータルサイト</a>"
        });

        var landslideLayer = L.tileLayer('https://disaportaldata.gsi.go.jp/raster/03_landslide_warning/{z}/{x}/{y}.png', {
            opacity: 0.5,
            attribution: "<a href='https://disaportal.gsi.go.jp/'>ハザードマップポータルサイト</a>"
        });

        var tsunamiLayer = L.tileLayer('https://disaportaldata.gsi.go.jp/raster/05_tsunami_shinsui/{z}/{x}/{y}.png', {
            opacity: 0.5,
            attribution: "<a href='https://disaportal.gsi.go.jp/'>ハザードマップポータルサイト</a>"
        });

        // レイヤーコントロールを追加
        var baseMaps = {
            "標準地図": stdMap
        };

        var overlayMaps = {
            "浸水想定区域": floodLayer,
            "土砂災害警戒区域": landslideLayer,
            "津波浸水想定区域": tsunamiLayer
        };

        L.control.layers(baseMaps, overlayMaps).addTo(map);

        // ピンのアイコン設定（Leafletデフォルトのアイコンを使用）
        var defaultIcon = L.icon({
            iconUrl: 'https://unpkg.com/leaflet@1.7.1/dist/images/marker-icon.png',
            iconRetinaUrl: 'https://unpkg.com/leaflet@1.7.1/dist/images/marker-icon-2x.png',
            shadowUrl: 'https://unpkg.com/leaflet@1.7.1/dist/images/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41]
        });

        // ピンを管理する配列
        var pins = [];

        // 一時的な空のピンを保持する変数
        var currentEmptyPin = null;

        // localStorageからピンのデータを読み込み
        loadPinsFromStorage();

        // マップをクリックしたときの処理
        map.on('click', function(e) {
            // ユーザー名が未入力の場合はアラートを表示
            if (!username.trim()) {
                alert(texts[currentLang].alertNoUsername);
                return;
            }

            // 既存の空のピンがあり、メッセージがない場合は削除
            if (currentEmptyPin && currentEmptyPin.data.messages.length === 0) {
                map.removeLayer(currentEmptyPin);
            }

            // 新しい空のピンを設置
            currentEmptyPin = L.marker(e.latlng, { icon: defaultIcon }).addTo(map);

            // ピンにメッセージを保存するオブジェクトを追加
            currentEmptyPin.data = {
                messages: []
            };

            // ピンにポップアップを設定
            currentEmptyPin.bindPopup(createPopupContent(currentEmptyPin)).openPopup();
        });

        // ポップアップの内容を生成
        function createPopupContent(marker) {
            var container = document.createElement('div');

            // メッセージフォーム
            var form = document.createElement('form');
            form.className = 'message-form';

            var textarea = document.createElement('textarea');
            textarea.placeholder = texts[currentLang].placeholderMessage;
            form.appendChild(textarea);

            var submitButton = document.createElement('input');
            submitButton.type = 'submit';
            submitButton.value = texts[currentLang].postButton;
            form.appendChild(submitButton);

            // メッセージリスト
            var messageList = document.createElement('div');
            messageList.className = 'message-list';

            // 既存のメッセージを表示
            marker.data.messages.forEach(function(msgObj) {
                var messageItem = document.createElement('div');
                messageItem.className = 'message-item';

                var authorSpan = document.createElement('span');
                authorSpan.className = 'message-author';
                authorSpan.textContent = sanitize(msgObj.author + ": ");

                var messageSpan = document.createElement('span');
                messageSpan.textContent = sanitize(msgObj.text);

                messageItem.appendChild(authorSpan);
                messageItem.appendChild(messageSpan);
                messageList.appendChild(messageItem);
            });

            // フォーム送信時の処理
            form.onsubmit = function(e) {
                e.preventDefault();
                var msg = textarea.value.trim();
                if (msg) {
                    var msgObj = {
                        author: username,
                        text: msg
                    };
                    marker.data.messages.push(msgObj);

                    var messageItem = document.createElement('div');
                    messageItem.className = 'message-item';

                    var authorSpan = document.createElement('span');
                    authorSpan.className = 'message-author';
                    authorSpan.textContent = sanitize(username + ": ");

                    var messageSpan = document.createElement('span');
                    messageSpan.textContent = sanitize(msg);

                    messageItem.appendChild(authorSpan);
                    messageItem.appendChild(messageSpan);
                    messageList.appendChild(messageItem);

                    textarea.value = '';
                    textarea.focus();

                    // 空のピンから正式なピンに移動
                    if (currentEmptyPin === marker) {
                        pins.push(marker);
                        currentEmptyPin = null;
                    }

                    // ピンのデータを保存
                    savePinsToStorage();
                }
            };

            container.appendChild(form);
            container.appendChild(messageList);

            // ピン削除ボタン
            var deleteLink = document.createElement('a');
            deleteLink.href = '#';
            deleteLink.className = 'delete-pin';
            deleteLink.textContent = texts[currentLang].deletePin;
            deleteLink.onclick = function(e) {
                e.preventDefault();
                map.removeLayer(marker);
                pins = pins.filter(function(pin) {
                    return pin !== marker;
                });
                // ピンのデータを保存
                savePinsToStorage();
            };
            container.appendChild(deleteLink);

            return container;
        }

        // サニタイズ関数（DOMPurifyを使用）
        function sanitize(str) {
            return DOMPurify.sanitize(str);
        }

        // 現在地を円形マーカーで表示
        function onLocationFound(e) {
            var radius = e.accuracy / 2;

            // 既存の現在地マーカーと精度円を削除
            if (currentLocationMarker) {
                map.removeLayer(currentLocationMarker);
            }
            if (currentLocationCircle) {
                map.removeLayer(currentLocationCircle);
            }

            // 円形マーカーを作成
            currentLocationMarker = L.circleMarker(e.latlng, {
                radius: 10,
                fillColor: '#3388ff',
                color: '#fff',
                weight: 2,
                opacity: 1,
                fillOpacity: 1
            }).addTo(map).bindPopup(texts[currentLang].currentLocation).openPopup();

            // 精度を示す円
            currentLocationCircle = L.circle(e.latlng, radius, {
                color: '#136AEC',
                fillColor: '#136AEC',
                fillOpacity: 0.15
            }).addTo(map);
        }

        var currentLocationMarker = null;
        var currentLocationCircle = null;

        map.on('locationfound', onLocationFound);

        // 位置情報取得失敗時の処理
        function onLocationError(e) {
            alert(texts[currentLang].alertLocationError);
        }

        map.on('locationerror', onLocationError);

        // 現在地ボタンを追加
        L.control.locate({
            position: 'topleft',
            drawCircle: false,
            showCompass: true,
            locateOptions: {
                maxZoom: 16,
                watch: true,
                setView: true
            },
            strings: {
                title: texts[currentLang].displayCurrentLocation
            },
            onLocationError: onLocationError,
            onLocationFound: onLocationFound
        }).addTo(map);

        // ピンのデータをlocalStorageに保存
        function savePinsToStorage() {
            var pinsData = pins.map(function(pin) {
                return {
                    latlng: pin.getLatLng(),
                    messages: pin.data.messages
                };
            });
            localStorage.setItem('pins', JSON.stringify(pinsData));
        }

        // localStorageからピンのデータを読み込み
        function loadPinsFromStorage() {
            var savedPins = localStorage.getItem('pins');
            if (savedPins) {
                var pinsData = JSON.parse(savedPins);
                pinsData.forEach(function(pinData) {
                    var pin = L.marker(pinData.latlng, { icon: defaultIcon }).addTo(map);
                    pin.data = {
                        messages: pinData.messages
                    };
                    pin.bindPopup(createPopupContent(pin));
                    pins.push(pin);
                });
            }
        }

        // ページ読み込み時にユーザー名が未設定の場合の処理
        if (!username.trim()) {
            setTimeout(function() {
                alert(texts[currentLang].alertNoUsername);
            }, 500);
        }

        // 防災情報を取得する関数（サンプル実装）
        function fetchDisasterInfo() {
            var disasterInfoDiv = document.getElementById('disasterInfo');
            disasterInfoDiv.innerHTML = texts[currentLang].disasterInfoLoading;

            // サンプルデータを表示します
            var sampleData = {
                title: "気象特別警報・警報・注意報",
                reportDatetime: "2023-10-14T15:00:00+09:00",
                text: "現在、特別警報は発表されていません。"
            };

            var infoHtml = '<p><strong>' + sanitize(sampleData.title) + '</strong><br>';
            infoHtml += '発表日時: ' + sanitize(sampleData.reportDatetime) + '</p>';
            infoHtml += '<p>' + sanitize(sampleData.text.replace(/\n/g, '<br>')) + '</p>';
            disasterInfoDiv.innerHTML = infoHtml;
        }

        // ページ読み込み時に防災情報を取得
        fetchDisasterInfo();

        // 一定時間ごとに防災情報を更新（5分ごと）
        setInterval(fetchDisasterInfo, 5 * 60 * 1000);

        // 医療情報モーダルの操作
        var medicalModal = document.getElementById('medicalModal');
        var openMedicalInfo = document.getElementById('openMedicalInfo');
        var closeMedicalModal = document.getElementById('closeMedicalModal');
        var medicalForm = document.getElementById('medicalForm');
        var logoutButton = document.getElementById('logoutButton');
        var exportButton = document.getElementById('exportData');
        var importButton = document.getElementById('importData');

        // パスワードを保持
        var medicalPassword = '';

        // ログイン状態を保持
        var isLoggedIn = false;

        // 医療情報を暗号化して保存
        function saveMedicalInfoEncrypted(data, password) {
            var ciphertext = CryptoJS.AES.encrypt(JSON.stringify(data), password).toString();
            localStorage.setItem('medicalInfo', ciphertext);
        }

        // 医療情報を復号化して読み込み
        function loadMedicalInfoDecrypted(password) {
            var ciphertext = localStorage.getItem('medicalInfo');
            if (ciphertext) {
                try {
                    var bytes = CryptoJS.AES.decrypt(ciphertext, password);
                    var decryptedData = JSON.parse(bytes.toString(CryptoJS.enc.Utf8));
                    return decryptedData;
                } catch (e) {
                    return null;
                }
            } else {
                return {
                    healthStatus: '',
                    allergies: '',
                    medications: '',
                    emergencyContact: ''
                };
            }
        }

        // 初回パスワード設定とログイン
        function initialLogin() {
            var password = prompt(texts[currentLang].enterPassword);
            if (password) {
                var confirmPassword = prompt(texts[currentLang].confirmPassword);
                if (password === confirmPassword) {
                    medicalPassword = password;
                    isLoggedIn = true;
                    alert(texts[currentLang].medicalInfoSaved);
                    openMedicalModal();
                } else {
                    alert(texts[currentLang].passwordMismatch);
                }
            }
        }

        // 既存パスワードでログイン
        function login() {
            var password = prompt(texts[currentLang].enterPassword);
            if (password) {
                var medicalInfo = loadMedicalInfoDecrypted(password);
                if (medicalInfo) {
                    medicalPassword = password;
                    isLoggedIn = true;
                    openMedicalModal(medicalInfo);
                } else {
                    alert(texts[currentLang].incorrectPassword);
                }
            }
        }

        // ログアウト
        logoutButton.onclick = function() {
            medicalPassword = '';
            isLoggedIn = false;
            medicalModal.style.display = 'none';
            alert(texts[currentLang].logout);
        };

        // モーダルを開く
        function openMedicalModal(medicalInfo) {
            if (!medicalInfo) {
                medicalInfo = loadMedicalInfoDecrypted(medicalPassword);
            }
            if (medicalInfo) {
                document.getElementById('healthStatus').value = medicalInfo.healthStatus;
                document.getElementById('allergies').value = medicalInfo.allergies;
                document.getElementById('medications').value = medicalInfo.medications;
                document.getElementById('emergencyContact').value = medicalInfo.emergencyContact;
                medicalModal.style.display = 'block';
            } else {
                alert(texts[currentLang].medicalInfoLoadFailed);
            }
        }

        // モーダルを開くボタンのイベント
        openMedicalInfo.onclick = function() {
            if (isLoggedIn) {
                openMedicalModal();
            } else {
                var hasMedicalInfo = localStorage.getItem('medicalInfo');
                if (hasMedicalInfo) {
                    login();
                } else {
                    initialLogin();
                }
            }
        };

        // モーダルを閉じる
        closeMedicalModal.onclick = function() {
            medicalModal.style.display = 'none';
        };

        // モーダル外をクリックしたときに閉じる
        window.onclick = function(event) {
            if (event.target == medicalModal) {
                medicalModal.style.display = 'none';
            }
        };

        // 医療情報フォームの送信処理
        medicalForm.onsubmit = function(e) {
            e.preventDefault();
            var medicalInfo = {
                healthStatus: document.getElementById('healthStatus').value.trim(),
                allergies: document.getElementById('allergies').value.trim(),
                medications: document.getElementById('medications').value.trim(),
                emergencyContact: document.getElementById('emergencyContact').value.trim()
            };
            saveMedicalInfoEncrypted(medicalInfo, medicalPassword);
            alert(texts[currentLang].medicalInfoSaved);
            medicalModal.style.display = 'none';
        };

        // データのエクスポート
        exportButton.onclick = function() {
            if (isLoggedIn) {
                var medicalInfo = loadMedicalInfoDecrypted(medicalPassword);
                if (medicalInfo) {
                    var dataStr = JSON.stringify(medicalInfo);
                    var blob = new Blob([dataStr], {type: "application/json"});
                    var url = URL.createObjectURL(blob);
                    var a = document.createElement('a');
                    a.href = url;
                    a.download = 'medical_info.json';
                    a.click();
                    URL.revokeObjectURL(url);
                } else {
                    alert(texts[currentLang].medicalInfoLoadFailed);
                }
            } else {
                alert(texts[currentLang].alertNoUsername);
            }
        };

        // データのインポート
        importButton.onclick = function() {
            if (isLoggedIn) {
                var input = document.createElement('input');
                input.type = 'file';
                input.accept = 'application/json';
                input.onchange = function(e) {
                    var file = e.target.files[0];
                    var reader = new FileReader();
                    reader.onload = function(evt) {
                        try {
                            var importedData = JSON.parse(evt.target.result);
                            saveMedicalInfoEncrypted(importedData, medicalPassword);
                            alert(texts[currentLang].medicalInfoSaved);
                            openMedicalModal(importedData);
                        } catch (err) {
                            alert('データのインポートに失敗しました。');
                        }
                    };
                    reader.readAsText(file);
                };
                input.click();
            } else {
                alert(texts[currentLang].alertNoUsername);
            }
        };

    </script>
</body>
</html>
