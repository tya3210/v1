<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>防災情報マップ - ハザードマップ対応版</title>
  <style>
    html, body, #map {
      height: 100%;
      margin: 0;
      padding: 0;
    }
    .leaflet-popup-content {
      font-size: 14px;
    }
    .message-form {
      margin: 0;
    }
    .message-form textarea {
      width: 100%;
      height: 60px;
      resize: none;
    }
    .message-list {
      max-height: 100px;
      overflow-y: auto;
      margin-top: 10px;
    }
    .message-item {
      border-bottom: 1px solid #ccc;
      padding: 5px 0;
    }
    .message-author {
      font-weight: bold;
      margin-right: 5px;
    }
    .delete-pin {
      color: red;
      cursor: pointer;
      font-size: 12px;
      display: block;
      margin-top: 10px;
    }
    .username-container {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 1000;
      background: rgba(255,255,255,0.9);
      padding: 10px;
      border-radius: 5px;
    }
    .username-container input {
      width: 150px;
    }
    /* フローティングウィンドウのスタイル */
    .info-window {
      position: absolute;
      bottom: 10px;
      left: 10px;
      z-index: 1000;
      background: rgba(255,255,255,0.9);
      padding: 10px;
      border-radius: 5px;
      max-width: 300px;
      max-height: 200px;
      overflow-y: auto;
      font-size: 14px;
    }
    .info-window h3 {
      margin-top: 0;
    }
    /* 物資管理機能のスタイル */
    .supply-management {
      margin-top: 10px;
      border-top: 1px solid #ccc;
      padding-top: 10px;
    }
    .supply-list {
      max-height: 100px;
      overflow-y: auto;
      margin-top: 5px;
    }
    .supply-item {
      border-bottom: 1px dashed #ddd;
      padding: 5px 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .supply-item:last-child {
      border-bottom: none;
    }
    .supply-name {
      margin-right: 10px;
    }
    .supply-expiry {
      font-size: 0.9em;
      color: #777;
    }
    .supply-expired {
      color: red;
      font-weight: bold;
    }
    .add-supply-button {
      margin-top: 5px;
      padding: 5px 10px;
      cursor: pointer;
    }
    .no-supplies {
      font-style: italic;
      color: #888;
    }
    /* 避難経路描画用のコントロール */
    .route-control {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 1000;
      background: rgba(255,255,255,0.9);
      padding: 10px;
      border-radius: 5px;
    }
    .route-control button {
      margin: 2px;
    }
  </style>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
</head>
<body>
  <div class="username-container">
    お名前: <input type="text" id="usernameInput" placeholder="ユーザー名を入力" />
  </div>
  <!-- 避難経路描画用コントロール -->
  <div class="route-control" id="routeControl">
    <button id="startRouteDrawing">避難経路描画モード開始</button>
    <button id="finishRouteDrawing" style="display:none;">描画終了</button>
    <button id="clearRoute" style="display:none;">経路クリア</button>
  </div>
  <div id="map"></div>
  <div class="info-window" id="infoWindow">
    <h3>防災情報</h3>
    <div id="disasterInfo">最新の防災情報を取得中です...</div>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@2.4.0/dist/purify.min.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.locatecontrol/dist/L.Control.Locate.min.css" />
  <script src="https://unpkg.com/leaflet.locatecontrol/dist/L.Control.Locate.min.js"></script>

  <script>
    // テキスト定義
    const texts = {
      mapTitle: "防災情報マップ",
      placeholderMessage: "伝言を入力してください",
      placeholderUsername: "ユーザー名を入力",
      postButton: "投稿",
      deletePin: "このピンを削除",
      currentLocation: "現在地",
      displayCurrentLocation: "現在地を表示",
      alertLocationError: "位置情報を取得できませんでした。",
      alertNoUsername: "ユーザー名を入力してください。",
      nameLabel: "お名前: ",
      disasterInfoTitle: "防災情報",
      disasterInfoLoading: "最新の防災情報を取得中です...",
      disasterInfoError: "防災情報を取得できませんでした。",
      noDisasterInfo: "現在、特別な防災情報はありません。",
      supplyManagementTitle: "物資管理",
      addSupplyButton: "物資を追加",
      supplyNamePlaceholder: "物資名",
      expiryDatePlaceholder: "賞味期限 (YYYY-MM-DD)",
      addSupplyItem: "追加",
      noSuppliesRegistered: "登録された物資はありません。",
      expiryDateFormatError: "賞味期限はYYYY-MM-DD形式で入力してください。",
      supplyItemDeleted: "物資を削除しました。",
      expiryNotification: "賞味期限切れの物資があります："
    };

    document.title = texts.mapTitle;

    // ユーザー名管理
    var username = localStorage.getItem('username') || '';
    var usernameInput = document.getElementById('usernameInput');
    usernameInput.value = username;
    usernameInput.placeholder = texts.placeholderUsername;
    usernameInput.addEventListener('change', function() {
      username = usernameInput.value.trim();
      localStorage.setItem('username', username);
    });

    // マップの初期化（東京駅を中心）
    var map = L.map('map', {
      center: [35.681236, 139.767125],
      zoom: 13
    });

    // 地理院標準タイル
    var stdMap = L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png', {
      attribution: "<a href='https://maps.gsi.go.jp/development/ichiran.html'>地理院タイル</a>"
    }).addTo(map);

    // ハザードマップレイヤー
    var floodLayer = L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/lcmfc2/{z}/{x}/{y}.png', {
      opacity: 0.5,
      attribution: "<a href='https://www.gsi.go.jp/bousaichiri/hazardmap.html'>国土地理院ハザードマップ</a>"
    });
    var landslideLayer = L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/lssh/{z}/{x}/{y}.png', {
      opacity: 0.5,
      attribution: "<a href='https://www.gsi.go.jp/bousaichiri/hazardmap.html'>国土地理院ハザードマップ</a>"
    });
    var tsunamiLayer = L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/lts/{z}/{x}/{y}.png', {
      opacity: 0.5,
      attribution: "<a href='https://www.gsi.go.jp/bousaichiri/hazardmap.html'>国土地理院ハザードマップ</a>"
    });
    var baseMaps = { "標準地図": stdMap };
    var overlayMaps = {
      "浸水想定区域": floodLayer,
      "土砂災害危険箇所": landslideLayer,
      "津波浸水想定区域": tsunamiLayer
    };
    L.control.layers(baseMaps, overlayMaps).addTo(map);

    // ピン用アイコン
    var emptyPinIcon = new L.Icon({
      iconUrl: 'https://maps.google.com/mapfiles/ms/icons/blue-dot.png',
      iconSize: [32, 32],
      iconAnchor: [16, 32],
      popupAnchor: [0, -32]
    });
    var messagePinIcon = new L.Icon({
      iconUrl: 'https://maps.google.com/mapfiles/ms/icons/red-dot.png',
      iconSize: [32, 32],
      iconAnchor: [16, 32],
      popupAnchor: [0, -32]
    });
    var pins = [];
    var currentEmptyPin = null;

    // 避難経路描画用グローバル変数
    var isDrawingRoute = false;
    var evacuationRoute = [];
    var routePolyline = null;

    // localStorage からピン・経路データを読み込み
    loadPinsFromStorage();
    loadRouteFromStorage();

    // マップクリック時の処理（避難経路描画モードかどうかで処理を分岐）
    map.on('click', function(e) {
      if (isDrawingRoute) {
        evacuationRoute.push(e.latlng);
        if (routePolyline) {
          routePolyline.setLatLngs(evacuationRoute);
        } else {
          routePolyline = L.polyline(evacuationRoute, { color: 'blue' }).addTo(map);
        }
        // 経路更新後は即時保存
        saveRouteToStorage();
        return;
      }
      // ユーザー名未入力の場合はアラート
      if (!username.trim()) {
        alert(texts.alertNoUsername);
        return;
      }
      // 既存の空ピン（メッセージがないもの）を削除
      if (currentEmptyPin && currentEmptyPin.data.messages.length === 0 && (!currentEmptyPin.data.supplies || currentEmptyPin.data.supplies.length === 0)) {
        map.removeLayer(currentEmptyPin);
      }
      // 新しい空ピンを設置
      currentEmptyPin = L.marker(e.latlng, { icon: emptyPinIcon }).addTo(map);
      currentEmptyPin.data = { messages: [], supplies: [] };
      currentEmptyPin.bindPopup(createPopupContent(currentEmptyPin)).openPopup();
    });

    // ピンのポップアップ内容生成
    function createPopupContent(marker) {
      var container = document.createElement('div');
      // メッセージフォーム
      var form = document.createElement('form');
      form.className = 'message-form';
      var textarea = document.createElement('textarea');
      textarea.placeholder = texts.placeholderMessage;
      form.appendChild(textarea);
      var submitButton = document.createElement('input');
      submitButton.type = 'submit';
      submitButton.value = texts.postButton;
      form.appendChild(submitButton);
      // メッセージリスト
      var messageList = document.createElement('div');
      messageList.className = 'message-list';
      marker.data.messages.forEach(function(msgObj) {
        var messageItem = document.createElement('div');
        messageItem.className = 'message-item';
        var authorSpan = document.createElement('span');
        authorSpan.className = 'message-author';
        authorSpan.textContent = sanitize(msgObj.author + ": ");
        var messageSpan = document.createElement('span');
        messageSpan.textContent = sanitize(msgObj.text);
        messageItem.appendChild(authorSpan);
        messageItem.appendChild(messageSpan);
        messageList.appendChild(messageItem);
      });
      // フォーム送信処理
      form.onsubmit = function(e) {
        e.preventDefault();
        var msg = textarea.value.trim();
        if (msg) {
          var msgObj = { author: username, text: msg };
          marker.data.messages.push(msgObj);
          var messageItem = document.createElement('div');
          messageItem.className = 'message-item';
          var authorSpan = document.createElement('span');
          authorSpan.className = 'message-author';
          authorSpan.textContent = sanitize(username + ": ");
          var messageSpan = document.createElement('span');
          messageSpan.textContent = sanitize(msg);
          messageItem.appendChild(authorSpan);
          messageItem.appendChild(messageSpan);
          messageList.appendChild(messageItem);
          textarea.value = '';
          textarea.focus();
          // 空ピンから正式なピンへ変更
          if (currentEmptyPin === marker) {
            marker.setIcon(messagePinIcon);
            pins.push(marker);
            currentEmptyPin = null;
          }
          savePinsToStorage();
        }
      };
      container.appendChild(form);
      container.appendChild(messageList);
      // 物資管理機能
      var supplyManagementDiv = document.createElement('div');
      supplyManagementDiv.className = 'supply-management';
      var supplyTitle = document.createElement('h4');
      supplyTitle.textContent = texts.supplyManagementTitle;
      supplyManagementDiv.appendChild(supplyTitle);
      var supplyListDiv = document.createElement('div');
      supplyListDiv.className = 'supply-list';
      if (marker.data.supplies && marker.data.supplies.length > 0) {
        marker.data.supplies.forEach(function(supply, index) {
          var supplyItemDiv = createSupplyItemElement(supply, marker, index);
          supplyListDiv.appendChild(supplyItemDiv);
        });
      } else {
        var noSuppliesMessage = document.createElement('p');
        noSuppliesMessage.className = 'no-supplies';
        noSuppliesMessage.textContent = texts.noSuppliesRegistered;
        supplyListDiv.appendChild(noSuppliesMessage);
      }
      supplyManagementDiv.appendChild(supplyListDiv);
      var addSupplyButton = document.createElement('button');
      addSupplyButton.textContent = texts.addSupplyButton;
      addSupplyButton.className = 'add-supply-button';
      addSupplyButton.onclick = function() {
        showAddSupplyForm(marker, supplyListDiv);
      };
      supplyManagementDiv.appendChild(addSupplyButton);
      container.appendChild(supplyManagementDiv);
      // ピン削除リンク
      var deleteLink = document.createElement('a');
      deleteLink.href = '#';
      deleteLink.className = 'delete-pin';
      deleteLink.textContent = texts.deletePin;
      deleteLink.onclick = function(e) {
        e.preventDefault();
        map.removeLayer(marker);
        pins = pins.filter(function(pin) { return pin !== marker; });
        savePinsToStorage();
      };
      container.appendChild(deleteLink);
      return container;
    }

    function createSupplyItemElement(supply, marker, index) {
      var supplyItemDiv = document.createElement('div');
      supplyItemDiv.className = 'supply-item';
      var supplyNameSpan = document.createElement('span');
      supplyNameSpan.className = 'supply-name';
      supplyNameSpan.textContent = sanitize(supply.name);
      supplyItemDiv.appendChild(supplyNameSpan);
      var expiryDate = new Date(supply.expiryDate);
      var formattedExpiryDate = supply.expiryDate;
      var expirySpan = document.createElement('span');
      expirySpan.className = 'supply-expiry';
      expirySpan.textContent = texts.expiryDatePlaceholder + ": " + formattedExpiryDate;
      if (expiryDate < new Date()) {
        expirySpan.classList.add('supply-expired');
      }
      supplyItemDiv.appendChild(expirySpan);
      var deleteButton = document.createElement('button');
      deleteButton.textContent = 'x';
      deleteButton.onclick = function() {
        marker.data.supplies.splice(index, 1);
        savePinsToStorage();
        supplyItemDiv.remove();
        if (marker.data.supplies.length === 0) {
          let supplyListDiv = supplyItemDiv.parentElement;
          let noSuppliesMessage = document.createElement('p');
          noSuppliesMessage.className = 'no-supplies';
          noSuppliesMessage.textContent = texts.noSuppliesRegistered;
          supplyListDiv.appendChild(noSuppliesMessage);
        }
        alert(texts.supplyItemDeleted);
      };
      supplyItemDiv.appendChild(deleteButton);
      return supplyItemDiv;
    }

    function showAddSupplyForm(marker, supplyListDiv) {
      var formContainer = document.createElement('div');
      formContainer.className = 'add-supply-form';
      var nameInput = document.createElement('input');
      nameInput.type = 'text';
      nameInput.placeholder = texts.supplyNamePlaceholder;
      formContainer.appendChild(nameInput);
      var expiryInput = document.createElement('input');
      expiryInput.type = 'date';
      expiryInput.placeholder = texts.expiryDatePlaceholder;
      formContainer.appendChild(expiryInput);
      var addButton = document.createElement('button');
      addButton.textContent = texts.addSupplyItem;
      addButton.onclick = function() {
        var supplyName = nameInput.value.trim();
        var expiryDateStr = expiryInput.value;
        if (!supplyName) {
          alert(texts.supplyNamePlaceholder + texts.alertNoUsername);
          return;
        }
        if (!isValidDate(expiryDateStr)) {
          alert(texts.expiryDateFormatError);
          return;
        }
        var supply = { name: supplyName, expiryDate: expiryDateStr };
        marker.data.supplies.push(supply);
        let noSuppliesMessage = supplyListDiv.querySelector('.no-supplies');
        if (noSuppliesMessage) {
          noSuppliesMessage.remove();
        }
        var supplyItemDiv = createSupplyItemElement(supply, marker, marker.data.supplies.length - 1);
        supplyListDiv.appendChild(supplyItemDiv);
        savePinsToStorage();
        marker.getPopup().setContent(createPopupContent(marker));
        marker.openPopup();
      };
      formContainer.appendChild(addButton);
      var popup = marker.getPopup();
      popup.setContent('');
      popup.setContent(formContainer);
    }

    function isValidDate(dateStr) {
      return /^\d{4}-\d{2}-\d{2}$/.test(dateStr);
    }
    function sanitize(str) {
      return DOMPurify.sanitize(str);
    }

    // 現在地表示
    function onLocationFound(e) {
      var radius = e.accuracy / 2;
      if (currentLocationMarker) {
        map.removeLayer(currentLocationMarker);
      }
      if (currentLocationCircle) {
        map.removeLayer(currentLocationCircle);
      }
      currentLocationMarker = L.circleMarker(e.latlng, {
        radius: 10,
        fillColor: '#3388ff',
        color: '#fff',
        weight: 2,
        opacity: 1,
        fillOpacity: 1
      }).addTo(map).bindPopup(texts.currentLocation).openPopup();
      currentLocationCircle = L.circle(e.latlng, radius, {
        color: '#136AEC',
        fillColor: '#136AEC',
        fillOpacity: 0.15
      }).addTo(map);
    }
    var currentLocationMarker = null;
    var currentLocationCircle = null;
    map.on('locationfound', onLocationFound);
    function onLocationError(e) {
      alert(texts.alertLocationError);
    }
    map.on('locationerror', onLocationError);
    L.control.locate({
      position: 'topleft',
      drawCircle: false,
      showCompass: true,
      locateOptions: {
        maxZoom: 16,
        watch: true,
        setView: true
      },
      strings: { title: texts.displayCurrentLocation },
      onLocationError: onLocationError,
      onLocationFound: onLocationFound
    }).addTo(map);

    // ピンのデータ保存／読み込み
    function savePinsToStorage() {
      var pinsData = pins.map(function(pin) {
        return {
          latlng: pin.getLatLng(),
          messages: pin.data.messages,
          supplies: pin.data.supplies
        };
      });
      localStorage.setItem('pins', JSON.stringify(pinsData));
    }
    function loadPinsFromStorage() {
      var savedPins = localStorage.getItem('pins');
      if (savedPins) {
        var pinsData = JSON.parse(savedPins);
        pinsData.forEach(function(pinData) {
          var icon = (pinData.messages.length > 0 || pinData.supplies.length > 0) ? messagePinIcon : emptyPinIcon;
          var pin = L.marker(pinData.latlng, { icon: icon }).addTo(map);
          pin.data = { messages: pinData.messages, supplies: pinData.supplies || [] };
          pin.bindPopup(createPopupContent(pin));
          pins.push(pin);
        });
      }
    }

    // 経路データ保存／読み込み
    function saveRouteToStorage() {
      localStorage.setItem('evacuationRoute', JSON.stringify(evacuationRoute));
    }
    function loadRouteFromStorage() {
      var storedRoute = localStorage.getItem('evacuationRoute');
      if (storedRoute) {
        evacuationRoute = JSON.parse(storedRoute);
        if (evacuationRoute && evacuationRoute.length > 0) {
          routePolyline = L.polyline(evacuationRoute, { color: 'blue' }).addTo(map);
        }
      }
    }

    // ページ読み込み時、ユーザー名が未設定ならアラート
    if (!username.trim()) {
      setTimeout(function() { alert(texts.alertNoUsername); }, 500);
    }
    // 賞味期限チェック
    function checkExpiryDates() {
      let expiredSupplies = [];
      pins.forEach(pin => {
        if (pin.data.supplies) {
          pin.data.supplies.forEach(supply => {
            if (new Date(supply.expiryDate) < new Date()) {
              expiredSupplies.push(supply.name);
            }
          });
        }
      });
      if (expiredSupplies.length > 0) {
        alert(texts.expiryNotification + "\n- " + expiredSupplies.join("\n- "));
      }
    }
    checkExpiryDates();
    setInterval(checkExpiryDates, 24 * 60 * 60 * 1000);

    // 避難経路描画用ボタンのイベント登録
    var startRouteBtn = document.getElementById('startRouteDrawing');
    var finishRouteBtn = document.getElementById('finishRouteDrawing');
    var clearRouteBtn = document.getElementById('clearRoute');

    startRouteBtn.addEventListener('click', function() {
      isDrawingRoute = true;
      startRouteBtn.style.display = 'none';
      finishRouteBtn.style.display = 'inline-block';
      clearRouteBtn.style.display = 'inline-block';
      alert("避難経路描画モードです。マップをクリックして経路を描いてください。");
    });
    finishRouteBtn.addEventListener('click', function() {
      isDrawingRoute = false;
      startRouteBtn.style.display = 'inline-block';
      finishRouteBtn.style.display = 'none';
      // 描画終了時に経路を保存
      saveRouteToStorage();
      alert("避難経路の描画を終了しました。");
    });
    clearRouteBtn.addEventListener('click', function() {
      if (routePolyline) {
        map.removeLayer(routePolyline);
      }
      evacuationRoute = [];
      routePolyline = null;
      saveRouteToStorage();
      alert("避難経路をクリアしました。");
    });
  </script>
</body>
</html>
