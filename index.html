<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>é˜²ç½æƒ…å ±ãƒãƒƒãƒ— - æ”¹è‰¯ç‰ˆ</title>
    <style>
        html, body, #map {
            height: 100%;
            margin: 0;
            padding: 0;
        }
        .leaflet-popup-content {
            font-size: 14px;
        }
        .message-form {
            margin: 0;
        }
        .message-form textarea {
            width: 100%;
            height: 60px;
            resize: none;
        }
        .message-list {
            max-height: 100px;
            overflow-y: auto;
            margin-top: 10px;
        }
        .message-item {
            border-bottom: 1px solid #ccc;
            padding: 5px 0;
        }
        .message-author {
            font-weight: bold;
            margin-right: 5px;
        }
        .delete-pin {
            color: red;
            cursor: pointer;
            font-size: 12px;
            display: block;
            margin-top: 10px;
        }
        .username-container {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background: rgba(255,255,255,0.9);
            padding: 10px;
            border-radius: 5px;
        }
        .username-container input {
            width: 150px;
        }
        /* ãƒªãƒƒãƒè£…é£¾ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .disaster-info-container {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1001; /* username-containerã‚ˆã‚Šå‰é¢ã«è¡¨ç¤º */
            background-color: rgba(240, 240, 240, 0.9); /* è–„ã„èƒŒæ™¯è‰² */
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #ccc;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.2); /* å½±ã‚’è¿½åŠ  */
            width: 280px; /* å°‘ã—å¹…ã‚’åºƒã’ã‚‹ */
            font-size: 14px;
        }
        .disaster-info-container h3 {
            margin-top: 0;
            margin-bottom: 10px;
            font-weight: bold; /* ã‚¿ã‚¤ãƒˆãƒ«ã‚’å¤ªå­—ã« */
            font-size: 1.1em; /* å°‘ã—å¤§ãã */
        }
        .disaster-info-content {
            /* å¿…è¦ã«å¿œã˜ã¦ã‚³ãƒ³ãƒ†ãƒ³ãƒ„é ˜åŸŸã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’è¨­å®š */
        }
        .disaster-info-separator {
            border-bottom: 1px dashed #ccc; /* æ³¢ç·š */
            margin: 10px 0;
        }
        .disaster-info-none {
            font-style: italic; /* æƒ…å ±ãŒãªã„å ´åˆã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’italicã« */
            color: #777; /* å°‘ã—ã‚°ãƒ¬ãƒ¼ã« */
        }
    </style>
    <!-- Leafletã®CSSã‚’èª­ã¿è¾¼ã¿ -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
</head>
<body>
    <!-- é˜²ç½æƒ…å ±è¡¨ç¤ºãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ -->
    <div class="disaster-info-container">
        <h3>é˜²ç½æƒ…å ±</h3>
        <div id="disaster-info-content">
            <!-- é˜²ç½æƒ…å ±ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
        </div>
    </div>
    <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼åã®è¨­å®š -->
    <div class="username-container">
        ãŠåå‰: <input type="text" id="usernameInput" placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å…¥åŠ›" />
    </div>
    <div id="map"></div>

    <!-- Leafletã®JSã‚’èª­ã¿è¾¼ã¿ -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <!-- åœ°ç†é™¢ã‚¿ã‚¤ãƒ«èª­ã¿è¾¼ã¿ -->
    <script src="https://maps.gsi.go.jp/js/leaflet-gsi.js"></script>
    <!-- Leaflet.Locateã®CSSã¨JSã‚’èª­ã¿è¾¼ã¿ -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.locatecontrol/dist/L.Control.Locate.min.css" />
    <script src="https://unpkg.com/leaflet.locatecontrol/dist/L.Control.Locate.min.js"></script>
    <!-- ã‚µãƒ‹ã‚¿ã‚¤ã‚ºç”¨ã®DOMPurifyã‚’èª­ã¿è¾¼ã¿ -->
    <script src="https://cdn.jsdelivr.net/npm/dompurify@2.4.0/dist/purify.min.js"></script>
    <script>
        // è¨€èªè¨­å®šï¼ˆå¤šè¨€èªå¯¾å¿œã®ãŸã‚ã«ãƒ†ã‚­ã‚¹ãƒˆã‚’ã¾ã¨ã‚ã‚‹ï¼‰
        const texts = {
            mapTitle: "é˜²ç½æƒ…å ±ãƒãƒƒãƒ—",
            placeholderMessage: "ä¼è¨€ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„",
            placeholderUsername: "ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å…¥åŠ›",
            postButton: "æŠ•ç¨¿",
            deletePin: "ã“ã®ãƒ”ãƒ³ã‚’å‰Šé™¤",
            currentLocation: "ç¾åœ¨åœ°",
            displayCurrentLocation: "ç¾åœ¨åœ°ã‚’è¡¨ç¤º",
            alertLocationError: "ä½ç½®æƒ…å ±ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚",
            alertNoUsername: "ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚",
            nameLabel: "ãŠåå‰: "
        };

        document.title = texts.mapTitle;

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼åã®ç®¡ç†
        var username = localStorage.getItem('username') || '';
        var usernameInput = document.getElementById('usernameInput');
        usernameInput.value = username;
        usernameInput.placeholder = texts.placeholderUsername;

        usernameInput.addEventListener('change', function() {
            username = usernameInput.value.trim();
            localStorage.setItem('username', username);
        });

        // åœ°å›³ã®åˆæœŸåŒ– (ã‚ºãƒ¼ãƒ ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚’å‰Šé™¤)
        var map = L.map('map', {
            center: [35.681236, 139.767125], // æ±äº¬é§…ã®ä½ç½®
            zoom: 13,
            zoomControl: false // ã‚ºãƒ¼ãƒ ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚’éè¡¨ç¤ºã«ã™ã‚‹
        });

        // åœ°ç†é™¢åœ°å›³ã®æ¨™æº–ã‚¿ã‚¤ãƒ«ã‚’è¿½åŠ 
        var stdMap = L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png', {
            attribution: "<a href='https://maps.gsi.go.jp/development/ichiran.html'>åœ°ç†é™¢ã‚¿ã‚¤ãƒ«</a>"
        }).addTo(map);

        // ãƒã‚¶ãƒ¼ãƒ‰ãƒãƒƒãƒ—ã®ãƒ¬ã‚¤ãƒ¤ãƒ¼è¿½åŠ ï¼ˆæµ¸æ°´æƒ³å®šåŒºåŸŸï¼‰
        var floodLayer = L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/inundation/{z}/{x}/{y}.png', {
            opacity: 0.5
        });

        // ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚’è¿½åŠ 
        var baseMaps = {
            "æ¨™æº–åœ°å›³": stdMap
        };

        var overlayMaps = {
            "æµ¸æ°´æƒ³å®šåŒºåŸŸ": floodLayer
        };

        L.control.layers(baseMaps, overlayMaps).addTo(map);

        // ãƒ”ãƒ³ã®ã‚¢ã‚¤ã‚³ãƒ³è¨­å®š (ã‚¢ã‚¤ã‚³ãƒ³ã‚’ä¿®æ­£)
        var emptyPinIcon = L.icon({
            iconUrl: 'https://unpkg.com/leaflet/dist/images/marker-icon.png', // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã‚¢ã‚¤ã‚³ãƒ³ã«å¤‰æ›´
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34]
        });

        var messagePinIcon = L.icon({
            iconUrl: 'https://unpkg.com/leaflet/dist/images/marker-icon-2x.png', // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã‚¢ã‚¤ã‚³ãƒ³ (å°‘ã—è‰²é•ã„)
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34]
        });

        // ãƒ”ãƒ³ã‚’ç®¡ç†ã™ã‚‹é…åˆ—
        var pins = [];

        // ä¸€æ™‚çš„ãªç©ºã®ãƒ”ãƒ³ã‚’ä¿æŒã™ã‚‹å¤‰æ•°
        var currentEmptyPin = null;

        // localStorageã‹ã‚‰ãƒ”ãƒ³ã®ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
        loadPinsFromStorage();

        // ãƒãƒƒãƒ—ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã¨ãã®å‡¦ç†
        map.on('click', function(e) {
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼åãŒæœªå…¥åŠ›ã®å ´åˆã¯ã‚¢ãƒ©ãƒ¼ãƒˆã‚’è¡¨ç¤º
            if (!username.trim()) {
                alert(texts.alertNoUsername);
                return;
            }

            // æ—¢å­˜ã®ç©ºã®ãƒ”ãƒ³ãŒã‚ã‚Šã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒãªã„å ´åˆã¯å‰Šé™¤
            if (currentEmptyPin && currentEmptyPin.data.messages.length === 0) {
                map.removeLayer(currentEmptyPin);
            }

            // æ–°ã—ã„ç©ºã®ãƒ”ãƒ³ã‚’è¨­ç½®
            currentEmptyPin = L.marker(e.latlng, { icon: emptyPinIcon }).addTo(map);

            // ãƒ”ãƒ³ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä¿å­˜ã™ã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’è¿½åŠ 
            currentEmptyPin.data = {
                messages: []
            };

            // ãƒ”ãƒ³ã«ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’è¨­å®š
            currentEmptyPin.bindPopup(createPopupContent(currentEmptyPin)).openPopup();
        });

        // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã®å†…å®¹ã‚’ç”Ÿæˆ
        function createPopupContent(marker) {
            var container = document.createElement('div');

            // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ•ã‚©ãƒ¼ãƒ 
            var form = document.createElement('form');
            form.className = 'message-form';

            var textarea = document.createElement('textarea');
            textarea.placeholder = texts.placeholderMessage;
            form.appendChild(textarea);

            var submitButton = document.createElement('input');
            submitButton.type = 'submit';
            submitButton.value = texts.postButton;
            form.appendChild(submitButton);

            // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒªã‚¹ãƒˆ
            var messageList = document.createElement('div');
            messageList.className = 'message-list';

            // æ—¢å­˜ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
            marker.data.messages.forEach(function(msgObj) {
                var messageItem = document.createElement('div');
                messageItem.className = 'message-item';

                var authorSpan = document.createElement('span');
                authorSpan.className = 'message-author';
                authorSpan.textContent = sanitize(msgObj.author + ": ");

                var messageSpan = document.createElement('span');
                messageSpan.textContent = sanitize(msgObj.text);

                messageItem.appendChild(authorSpan);
                messageItem.appendChild(messageSpan);
                messageList.appendChild(messageItem);
            });

            // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡æ™‚ã®å‡¦ç†
            form.onsubmit = function(e) {
                e.preventDefault();
                var msg = textarea.value.trim();
                if (msg) {
                    var msgObj = {
                        author: username,
                        text: msg
                    };
                    marker.data.messages.push(msgObj);

                    var messageItem = document.createElement('div');
                    messageItem.className = 'message-item';

                    var authorSpan = document.createElement('span');
                    authorSpan.className = 'message-author';
                    authorSpan.textContent = sanitize(username + ": ");

                    var messageSpan = document.createElement('span');
                    messageSpan.textContent = sanitize(msg);

                    messageItem.appendChild(authorSpan);
                    messageItem.appendChild(messageSpan);
                    messageList.appendChild(messageItem);

                    textarea.value = '';
                    textarea.focus();

                    // ç©ºã®ãƒ”ãƒ³ã‹ã‚‰æ­£å¼ãªãƒ”ãƒ³ã«ç§»å‹•
                    if (currentEmptyPin === marker) {
                        // ã‚¢ã‚¤ã‚³ãƒ³ã‚’å¤‰æ›´
                        marker.setIcon(messagePinIcon);
                        pins.push(marker);
                        currentEmptyPin = null;
                    }

                    // ãƒ”ãƒ³ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
                    savePinsToStorage();
                }
            };

            container.appendChild(form);
            container.appendChild(messageList);

            // ãƒ”ãƒ³å‰Šé™¤ãƒœã‚¿ãƒ³
            var deleteLink = document.createElement('a');
            deleteLink.href = '#';
            deleteLink.className = 'delete-pin';
            deleteLink.textContent = texts.deletePin;
            deleteLink.onclick = function(e) {
                e.preventDefault();
                map.removeLayer(marker);
                pins = pins.filter(function(pin) {
                    return pin !== marker;
                });
                // ãƒ”ãƒ³ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
                savePinsToStorage();
            };
            container.appendChild(deleteLink);

            return container;
        }

        // ã‚µãƒ‹ã‚¿ã‚¤ã‚ºé–¢æ•°ï¼ˆDOMPurifyã‚’ä½¿ç”¨ï¼‰
        function sanitize(str) {
            return DOMPurify.sanitize(str);
        }

        // ç¾åœ¨åœ°ã‚’å††å½¢ãƒãƒ¼ã‚«ãƒ¼ã§è¡¨ç¤º
        function onLocationFound(e) {
            var radius = e.accuracy / 2;

            // æ—¢å­˜ã®ç¾åœ¨åœ°ãƒãƒ¼ã‚«ãƒ¼ã¨ç²¾åº¦å††ã‚’å‰Šé™¤
            if (currentLocationMarker) {
                map.removeLayer(currentLocationMarker);
            }
            if (currentLocationCircle) {
                map.removeLayer(currentLocationCircle);
            }

            // å††å½¢ãƒãƒ¼ã‚«ãƒ¼ã‚’ä½œæˆ
            currentLocationMarker = L.circleMarker(e.latlng, {
                radius: 10,
                fillColor: '#3388ff',
                color: '#fff',
                weight: 2,
                opacity: 1,
                fillOpacity: 1
            }).addTo(map).bindPopup(texts.currentLocation).openPopup();

            // ç²¾åº¦ã‚’ç¤ºã™å†† (ç²¾åº¦å††ã‚’å‰Šé™¤)
            // currentLocationCircle = L.circle(e.latlng, radius, {
            //     color: '#136AEC',
            //     fillColor: '#136AEC',
            //     fillOpacity: 0.15
            // }).addTo(map);
        }

        var currentLocationMarker = null;
        var currentLocationCircle = null;

        map.on('locationfound', onLocationFound);

        // ä½ç½®æƒ…å ±å–å¾—å¤±æ•—æ™‚ã®å‡¦ç†
        function onLocationError(e) {
            alert(texts.alertLocationError);
        }

        map.on('locationerror', onLocationError);

        // ç¾åœ¨åœ°ãƒœã‚¿ãƒ³ã‚’è¿½åŠ  (ç²¾åº¦å††ã‚’éè¡¨ç¤ºã€å³ä¸‹ã«ç§»å‹•)
        L.control.locate({
            position: 'bottomright', // å³ä¸‹ã«ç§»å‹•
            drawCircle: false, // ç²¾åº¦å††ã‚’éè¡¨ç¤ºã«ã™ã‚‹è¨­å®š
            showCompass: true,
            locateOptions: {
                maxZoom: 16,
                watch: true,
                setView: true
            },
            strings: {
                title: texts.displayCurrentLocation
            },
            onLocationError: onLocationError,
            onLocationFound: onLocationFound
        }).addTo(map);

        // ãƒ”ãƒ³ã®ãƒ‡ãƒ¼ã‚¿ã‚’localStorageã«ä¿å­˜
        function savePinsToStorage() {
            var pinsData = pins.map(function(pin) {
                return {
                    latlng: pin.getLatLng(),
                    messages: pin.data.messages
                };
            });
            localStorage.setItem('pins', JSON.stringify(pinsData));
        }

        // localStorageã‹ã‚‰ãƒ”ãƒ³ã®ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
        function loadPinsFromStorage() {
            var savedPins = localStorage.getItem('pins');
            if (savedPins) {
                var pinsData = JSON.parse(savedPins);
                pinsData.forEach(function(pinData) {
                    var icon = pinData.messages.length > 0 ? messagePinIcon : emptyPinIcon;
                    var pin = L.marker(pinData.latlng, { icon: icon }).addTo(map);
                    pin.data = {
                        messages: pinData.messages
                    };
                    pin.bindPopup(createPopupContent(pin));
                    pins.push(pin);
                });
            }
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼åãŒæœªè¨­å®šã®å ´åˆã®å‡¦ç†
        if (!username.trim()) {
            setTimeout(function() {
                alert(texts.alertNoUsername);
            }, 500);
        }

        // **é˜²ç½æƒ…å ±è¡¨ç¤ºã®JavaScript**
        // ãƒ¢ãƒƒã‚¯ã®é˜²ç½æƒ…å ±ãƒ‡ãƒ¼ã‚¿ (å®Ÿéš›ã«ã¯æ°—è±¡åºAPIãªã©ã‹ã‚‰å–å¾—ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™)
        var mockDisasterData = {
            earthquakes: [
                { location: "åƒè‘‰çœŒæ±æ–¹æ²–", magnitude: 5.2, time: "10åˆ†å‰" },
                { location: "å®®åŸçœŒæ²–", magnitude: 4.8, time: "30åˆ†å‰" }
            ],
            tsunamis: [
                { region: "æ´¥æ³¢æ³¨æ„å ±ï¼š***", status: "ç™ºè¡¨ä¸­" }
            ],
            otherAlerts: [
                { type: "å¤§é›¨æ³¨æ„å ±", areas: ["æ±äº¬éƒ½", "ç¥å¥ˆå·çœŒ"], status: "ç™ºè¡¨ä¸­" }
            ]
        };

        // é˜²ç½æƒ…å ±è¡¨ç¤ºã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
        function updateDisasterInfo() {
            var disasterInfoContent = document.getElementById('disaster-info-content');
            var html = "";

            if (mockDisasterData.earthquakes.length > 0) {
                html += "<h4><span aria-label='åœ°éœ‡' role='img'>åœ°éœ‡ </span>åœ°éœ‡æƒ…å ±</h4><ul>"; // åœ°éœ‡ã‚¢ã‚¤ã‚³ãƒ³ï¼ˆçµµæ–‡å­—ï¼‰
                mockDisasterData.earthquakes.forEach(function(eq) {
                    html += `<li>${eq.time} - ${eq.location} - M${eq.magnitude}</li>`;
                });
                html += "</ul><div class='disaster-info-separator'></div>"; // åŒºåˆ‡ã‚Šç·šã‚’è¿½åŠ 
            }

            if (mockDisasterData.tsunamis.length > 0) {
                html += "<h4><span aria-label='æ´¥æ³¢' role='img'>ğŸŒŠ</span>æ´¥æ³¢æƒ…å ±</h4><ul>"; // æ´¥æ³¢ã‚¢ã‚¤ã‚³ãƒ³ï¼ˆçµµæ–‡å­—ï¼‰
                mockDisasterData.tsunamis.forEach(function(tsunami) {
                    html += `<li>${tsunami.region} - ${tsunami.status}</li>`;
                });
                html += "</ul><div class='disaster-info-separator'></div>"; // åŒºåˆ‡ã‚Šç·šã‚’è¿½åŠ 
            }

            if (mockDisasterData.otherAlerts.length > 0) {
                html += "<h4><span aria-label='è­¦å ±ãƒ»æ³¨æ„å ±' role='img'>âš ï¸</span>é˜²ç½è­¦å ±ãƒ»æ³¨æ„å ±</h4><ul>"; // è­¦å ±ãƒ»æ³¨æ„å ±ã‚¢ã‚¤ã‚³ãƒ³ï¼ˆçµµæ–‡å­—ï¼‰
                mockDisasterData.otherAlerts.forEach(function(alert) {
                    html += `<li>${alert.type} (${alert.areas.join(', ')}) - ${alert.status}</li>`;
                });
                html += "</ul>";
            }

            if (html === "") {
                html = "<p class='disaster-info-none'>ç¾åœ¨ã€é˜²ç½æƒ…å ±ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>"; // æƒ…å ±ãŒãªã„å ´åˆã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å¼·èª¿
            }

            disasterInfoContent.innerHTML = html;
        }

        // åˆå›è¡¨ç¤º
        updateDisasterInfo();

        // å®šæœŸçš„ã«æ›´æ–°ã™ã‚‹å ´åˆ (ä»Šå›ã¯ãƒ¢ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ãªã®ã§å¿…é ˆã§ã¯ãªã„ã§ã™ãŒã€å®Ÿéš›ã®APIã‹ã‚‰å–å¾—ã™ã‚‹éš›ã¯åˆ©ç”¨ã—ã¾ã™)
        // setInterval(updateDisasterInfo, 60 * 1000); // 1åˆ†ã”ã¨ã«æ›´æ–° (ä¾‹)

    </script>
</body>
</html>
